@page "/process-blazor/{Id}"
@using Cvl.ApplicationServer.Server.Node.Host
@using Cvl.ApplicationServer.Server.Node.Processes.Interfaces
@using Cvl.ApplicationServer.Server.Node.Processes.Model.UI.BlazorFrontEnd

@inject IProcessEngine ProcessEngine

<div>
    @switch (ViewModel.ProcessName)
    {
        case "BankLoanProcess":
            <Example.BlazorWasm.Processes.Pages.BankLoanProcess.ProcessComponent ViewModel="@ViewModel">
            </Example.BlazorWasm.Processes.Pages.BankLoanProcess.ProcessComponent>
            break;
        case "SimpleTestProcess":
            <Example.BlazorWasm.Processes.Pages.SimpleTestProcess.ProcessComponent ViewModel="@ViewModel">
            </Example.BlazorWasm.Processes.Pages.SimpleTestProcess.ProcessComponent>
            break;
    }
</div>



@code {

            [Parameter]
            public string Id { get; set; }

    public BlazorViewModel ViewModel { get; set; }

    private object applicatnioLock = new object();
    public static ApplicationServerNodeHost ApplicationServer = null;

    protected override void OnInitialized()
    {
        ViewModel = new BlazorViewModel();
        ViewModel.ProcessId = long.Parse(Id);

        lock (applicatnioLock)
        {
            if (ApplicationServer == null)
            {
                ApplicationServer = new ApplicationServerNodeHost();
                ApplicationServer.UseConfiguration = false;
                ApplicationServer.Start(startBackgroundProcessThread: true);

                var procesId = ApplicationServer.ProcessManager.StartProcess("Cvl.ApplicationServer.Server.Node.Processes.TestProcess.BankLoanProcess");

                var desc2 = ProcessEngine.GetProcessData(ViewModel.ProcessId);
            }
        }


        var desc = ProcessEngine.GetProcessData(ViewModel.ProcessId);
        if (desc.ProcessStatus == Cvl.ApplicationServer.Server.Node.Processes.Model.EnumProcessStatus.WaitingForUserData)
        {
            var formName = desc.FormData.FormName;
            var names = formName.Split('/');
            ViewModel.ProcessName = names[0];
            ViewModel.ProcessViewName = names[1];
            ViewModel.Model = desc.FormData.FormModel.GetModel();
        }
    }
}